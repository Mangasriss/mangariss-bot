<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangaCloud Reader</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #fff; --accent: #BB86FC; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow-x: hidden; }
        
        /* Navigation */
        .header { padding: 15px; text-align: center; border-bottom: 1px solid #333; background: #1a1a1a; position: sticky; top:0; z-index: 50;}
        .app-title { margin: 0; font-size: 1.2rem; color: var(--accent); cursor: pointer; }

        /* Grille Mangas */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .card { background: var(--card); border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card-title { padding: 8px; font-size: 0.9rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Vue Détail (Liste Chapitres) */
        #detail-view { display: none; padding: 20px; max-width: 800px; margin: 0 auto; }
        .manga-header { display: flex; gap: 20px; margin-bottom: 20px; align-items: end; }
        .cover-large { width: 120px; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .chap-btn { display: block; background: #333; padding: 12px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .chap-btn:hover { background: var(--accent); color: #000; }

        /* LECTEUR (Reader) */
        #reader-view { display: none; background: #000; min-height: 100vh; }
        #reader-pages { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; }
        .page-img { width: 100%; display: block; margin: 0; }
        
        /* Boutons Navigation */
        .nav-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 10px; }
        .close-reader { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: black; border: none; padding: 15px; border-radius: 50%; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; z-index: 100; }
    </style>
</head>
<body>

<div class="header">
    <h1 class="app-title" onclick="goHome()">☁️ MangaCloud</h1>
</div>

<div id="home-view" class="container">
    <div id="grid" class="grid">Chargement...</div>
</div>

<div id="detail-view">
    <button class="nav-btn" onclick="goHome()">⬅️ Retour liste</button>
    <div id="manga-info"></div>
    <div id="chap-list"></div>
</div>

<div id="reader-view">
    <div id="reader-pages"></div>
    <button class="close-reader" onclick="closeReader()">X</button>
</div>

<script>
    const API = './api';
    let currentManga = null;

    // 1. Charger la liste des mangas
    async function init() {
        try {
            const res = await fetch(`${API}/mangas.json`);
            const mangas = await res.json();
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            mangas.forEach(m => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `<img src="${m.cover}" loading="lazy"><div class="card-title">${m.title}</div>`;
                div.onclick = () => loadDetail(m.id);
                grid.appendChild(div);
            });
        } catch(e) { console.error(e); }
    }

    // 2. Ouvrir les détails d'un manga
    async function loadDetail(slug) {
        switchView('detail');
        const list = document.getElementById('chap-list');
        list.innerHTML = 'Chargement...';
        
        const res = await fetch(`${API}/details/${slug}.json`);
        const data = await res.json();
        currentManga = data;

        // Info Manga
        document.getElementById('manga-info').innerHTML = `
            <div class="manga-header">
                <img src="${data.cover}" class="cover-large">
                <div>
                    <h2>${data.title}</h2>
                    <p>${data.author}</p>
                    <p>${data.chapters.length} chapitres</p>
                </div>
            </div>
        `;

        // Liste Chapitres
        list.innerHTML = '';
        data.chapters.sort((a,b) => b.number - a.number); // Tri descendant
        
        data.chapters.forEach(c => {
            const div = document.createElement('div');
            div.className = 'chap-btn';
            div.innerHTML = `<b>#${c.number}</b> - ${c.title || 'Sans titre'}`;
            // Au clic, on lance le lecteur avec le dossier ET le nombre de pages
            div.onclick = () => openReader(c.folder_url, c.pages_count);
            list.appendChild(div);
        });
    }

    // 3. Ouvrir le Lecteur (La partie importante)
    function openReader(folderUrl, pageCount) {
        switchView('reader');
        const container = document.getElementById('reader-pages');
        container.innerHTML = ''; // Vide l'ancien chapitre

        // Boucle pour générer toutes les images (01.png à XX.png)
        for (let i = 1; i <= pageCount; i++) {
            const img = document.createElement('img');
            // Formatage 01, 02...
            const num = i.toString().padStart(2, '0');
            img.src = `${folderUrl}${num}.png`;
            img.className = 'page-img';
            img.loading = "lazy"; // Charge l'image seulement quand on scrolle dessus
            
            // Gestion erreur (si une page manque)
            img.onerror = function() { this.style.display = 'none'; };
            
            container.appendChild(img);
        }
    }

    // Utilitaires
    function switchView(viewName) {
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('detail-view').style.display = 'none';
        document.getElementById('reader-view').style.display = 'none';
        
        if(viewName === 'home') document.getElementById('home-view').style.display = 'block';
        if(viewName === 'detail') document.getElementById('detail-view').style.display = 'block';
        if(viewName === 'reader') document.getElementById('reader-view').style.display = 'block';
        
        if(viewName !== 'reader') window.scrollTo(0,0);
    }

    function goHome() { switchView('home'); }
    function closeReader() { switchView('detail'); }

    init();
</script>
</body>
</html>